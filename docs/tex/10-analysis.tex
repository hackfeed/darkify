\chapter{Аналитическая часть}

В данном разделе описаны цветовые модели, пригодные для решения задачи, выбор цветовой модели, модели контраста, выбор модели контраста, а также анализ возможных и существующих решений.

\section{Формализация задачи}

Ресурсы в сети Интернет представлены в виде веб-сайтов \cite{webpage}, веб-сайты в свою очередь состоят из веб-страниц. Веб-страница -- это документ, который может быть отображён веб-браузерами, такими как: Firefox, Google Chrome, Microsoft Internet Explorer / Edge или Safari от Apple \cite{webpage}. Веб-страница состоит из множества компонентов: текст, изображения, фон и т.п. Каждый компонент имеет свои цветовые параметры, количество которых зависит от используемой цветовой модели.

Для преобразования цветовой схемы веб-страниц используется таблица стилей CSS \cite{css}. С помощью CSS можно настраивать параметры отображения компонентов веб-страницы (цвет, яркость и т.п.). Разработчики веб-страниц вручную добавляют расширения для таблицы стилей для поддержки ночного режима. Цель работы -- автоматизировать добавление ночного режима для веб-страниц, основываясь на анализе цветовой палитры \cite{colorpalette}.

В таблице стилей CSS при работе с цветами используется три цветовых модели: RGB, RGBA и HSL, поэтому общее решение задачи можно представить в виде формулы \ref{eq:convert}:
\begin{equation}
	\label{eq:convert}
	CM_{converted} = F(CM_{initial}),
\end{equation}
где $F$ -- функция преобразования цветовой модели, $CM_{initial}$ и $CM_{converted}$ -- начальная и преобразованная цветовые модели соответственно.

\section{Цветовая модель}

Цветовая модель -- термин, обозначающий абстрактную модель описания представления цветов в виде кортежей чисел, называемых цветовыми компонентами или цветовыми координатами. Вместе с методом интерпретации этих данных (например, определение условий воспроизведения или просмотра -- то есть задание способа реализации), цвета цветовой модели определяет цветовое пространство.

\subsection{Цветовая модель RGB}

Цветовая модель RGB описывает излучаемые цвета. Она основана на трёх базовых цветах: красный (Red), зелёный (Green) и синий (Blue). Остальные цвета получаются сочетанием базовых. Цвета такого типа называются аддитивными. В компьютерах для представления каждой из координат традиционно используется один октет, значения которого обозначаются для удобства целыми числами от 0 до 255 включительно. Она применяется в приборах, излучающих свет, таких, например, как мониторы, прожекторы, фильтры.

Инвертировать цвет, заданный в цветовой модели  RGB, можно при помощи формулы \ref{eq:invert} \cite{inverse}:
\begin{equation}
	\label{eq:invert}
	\begin{split}
		R_{inverted} = 255 - R_{initial} \\
		G_{inverted} = 255 - G_{initial} \\
		B_{inverted} = 255 - B_{initial} \\
	\end{split}
\end{equation}

Цветовая модель RGB в рамках задачи позволяет использовать метод наивной инверсии, который описан в 1.7.1.

\subsection{Цветовая модель HSL}

Цветовая модель HSL, HLS или HSI (от англ. Hue, Saturation, Lightness (Intensity)) -- цветовая модель, в которой цветовыми координатами являются тон, насыщенность и светлота.

\begin{itemize}
	\item Hue -- цветовой тон (например, красный, зелёный или сине-голубой). Варьируется в пределах 0--360°, однако иногда приводится к диапазону 0--100 или 0--1.
	\item Saturation -- насыщенность. Варьируется в пределах 0--100 или 0--1. Чем больше этот параметр, тем «чище» цвет, поэтому этот параметр иногда называют чистотой цвета. А чем ближе этот параметр к нулю, тем ближе цвет к нейтральному серому.
	\item Lightness (Intensity) -- светлота (яркость). Постоянный оттенок ($d$, $h$) приводит к вертикальному поперечному сечению. Также задаётся в пределах 0--100 и 0--1.
\end{itemize}

Цветовая модель HSL в рамках задачи позволяет использовать метод изменения цвета компонентов на основе анализа цветовой карты \cite{colormap}, который описан в 1.7.2, что дает более удобочитаемое \cite{sitereadability} представление.

\subsection{Цветовая модель HSLuv}

Цветовая модель HSLuv является альтернативной версией модели HSL, которая позволяет с большей точностью (градацией) задать контраст цвета.

Данная цветовая модель непригодна в рамках задачи, так как более плавная градация цвета ведет к получению сильно близких друг к другу цветов, что ухудшает читаемость.

\subsection{Цветовая модель CIELAB}

Цветовая модель CIELAB -- цветовая модель, в которой цветовыми координатами являются светлота от черного до белого, от зеленого до красного и от синего до желтого цветов.

\begin{itemize}
	\item L -- светлота от черного (0) до белого (100).
	\item A -- светлота от зеленого (-) до красного (+).
	\item B -- светлота от синего (-) до желтого (+).
\end{itemize}

Данная цветовая модель спроектирована так, что любое изменение числовых параметров компонент соответствующе влияет на визуальное восприятие.

Цветовая модель CIELAB непригодна в рамках задачи, так как не позволяет расчитать близость цветов в цветовой палитре, как это позволяют сделать подели HSL и HSLuv.

\subsection{Цветовая модель LCH}

Цветовая модель LCH -- "цилиндрическая" версия цветовой модели CIELAB, что означает, что вместо 6 цветовых параметров, доступных в CIELAB, используется только 4.

\begin{itemize}
	\item L -- светлота от черного (0) до белого (100).
	\item C -- расстояние от серого (0 -- 100).
	\item H -- направление цвета (0 -- 360) (0 -- красный, 90 -- желтый, 180 -- зеленый, 270 -- синий).
\end{itemize}

Цветовая модель LCH пригодна в рамках задачи, так как позволяет, как и модель HSL, рассчитывать близость цветов в цветовой палитре.

\section{Выбор цветовой модели для решения задачи}

Для решения задачи подходит 3 цветовых модели: RGB, HSL и LCH. В качестве основной модели выбрана модель HSL, так как она:

\begin{itemize}
	\item позволяет оценить близость цветов в цветовой палитре, что позволит при инверсии цветов подбирать наиболее близкие цвета, отталкиваясь от базового, для сохранения визуальной целостности веб-страницы;
	\item позволяет провести прямую конвертацию из RGB, в отличие от LCH. RGB -- самая распространенная цветовая модель, используемая в таблице стилей CSS \cite{cssmostusedcm}, поэтому данную конвертацию придется производить с большой частотой;
	\item изначально поддерживается таблицей стилей CSS, что позволит не производить обратную конвертацию в RGB.
\end{itemize}

\section{Конвертация цветов между цветовыми моделями}

В формулах \ref{eq:rgbtohslh} -- \ref{eq:rgbtohsll} представлены шаги для получения компонент цвета цветовой модели HSL из RGB \cite{hsl}.
\begin{equation}
	{\label{eq:rgbtohslh}\displaystyle H={\begin{cases}{\mbox{undefined}}&{\mbox{if }}MAX=MIN\\60^{\circ }\times {\frac {G-B}{MAX-MIN}}+0^{\circ },&{\mbox{if }}MAX=R\\&{\mbox{and }}G\geq B\\60^{\circ }\times {\frac {G-B}{MAX-MIN}}+360^{\circ },&{\mbox{if }}MAX=R\\&{\mbox{and }}G<B\\60^{\circ }\times {\frac {B-R}{MAX-MIN}}+120^{\circ },&{\mbox{if }}MAX=G\\60^{\circ }\times {\frac {R-G}{MAX-MIN}}+240^{\circ },&{\mbox{if }}MAX=B\end{cases}},}
\end{equation}
\begin{equation}
	{\label{eq:rgbtohsls0}\displaystyle S={\begin{cases}0&{\mbox{if }}L=0{\mbox{ or }}MAX=MIN\\{\frac {MAX-MIN}{MAX+MIN}}={\frac {MAX-MIN}{2L}},&{\mbox{if }}0<L\leq {\frac {1}{2}}\\{\frac {MAX-MIN}{2-(MAX+MIN)}}={\frac {MAX-MIN}{2-2L}},&{\mbox{if }}{\frac {1}{2}}<L<1\\\end{cases}},}
\end{equation} или, в общем случае
\begin{equation}
	{\label{eq:rgbtohsls1}\displaystyle S={\frac {MAX-MIN}{1-|1-(MAX+MIN)|}},}
\end{equation}
\begin{equation}
	{\label{eq:rgbtohsll}\displaystyle L={\begin{matrix}{\frac {1}{2}}\end{matrix}}(MAX+MIN),}
\end{equation} где:
\begin{itemize}
	\item R, G, B -- значения цвета в цветовой модели RGB, значения в диапазоне [0; 1] (R - красный, G - зелёный, B - синий);
	\item MAX -- максимум из трёх значений (R, G, B);
	\item MIN -- минимум из трёх значений (R, G, B);
	\item H -- тон [0; 360];
	\item S -- насыщенность [0; 1];
	\item L -- светлота [0; 1].
\end{itemize}

В формулах \ref{eq:hsltorgbr} -- \ref{eq:hsltorgbb} представлены шаги для получения компонент цвета цветовой модели RGB из HSL \cite{hsl}.
\begin{equation}
	{\label{eq:hsltorgbr}\displaystyle Q={\begin{cases}L\times (1.0+S),&{\mbox{if }}L<0.5\\L+S-(L\times S),&{\mbox{if }}L\geq 0.5\end{cases}}}
\end{equation}
\begin{equation}
	{\displaystyle P=2.0\times L-Q}
\end{equation}
\begin{equation}
	{\displaystyle H_{k}={H \over 360}}
\end{equation}
\begin{equation}
	{\displaystyle T_{R}=H_{k}+{\frac {1}{3}}}
\end{equation}
\begin{equation}
	{\displaystyle T_{G}=H_{k}}
\end{equation}
\begin{equation}
	{\displaystyle T_{B}=H_{k}-{\frac {1}{3}}}
\end{equation}
\begin{equation}
	{\displaystyle {\mbox{if }}T_{c}<0\rightarrow T_{c}=T_{c}+1.0\quad {\mbox{for each}}\,c=R,G,B}
\end{equation}
\begin{equation}
	{\displaystyle {\mbox{if }}T_{c}>1\rightarrow T_{c}=T_{c}-1.0\quad {\mbox{for each}}\,c=R,G,B}
\end{equation}
Для каждого цвета $c = R,G,B$:
\begin{equation}
	{\label{eq:hsltorgbb}\displaystyle \qquad \mathrm {color} _{c}={\begin{cases}P+\left((Q-P)\times 6.0\times T_{c}\right),&{\mbox{if }}T_{c}<{\frac {1}{6}}\\Q,&{\mbox{if }}{\frac {1}{6}}\leq T_{c}<{\frac {1}{2}}\\P+\left((Q-P)\times ({\frac {2}{3}}-T_{c})\times 6.0\right),&{\mbox{if }}{\frac {1}{2}}\leq T_{c}<{\frac {2}{3}}\\P,&{\mbox{otherwise }}\end{cases}}}
\end{equation}

\section{Модели контраста}

Контраст (фр. contraste) -- в оптике (сенситометрии и фотометрии) разница в характеристиках различных участков изображения, способность фотографического материала или оптической системы воспроизводить эту разницу, а также характеристика чувствительности глаза (зрительной системы) относительно яркости и цвета \cite{contrast}.

Контрастность (также в различных контекстах употребляется и само слово контраст и коэффициент контраста) -- степень контраста, чаще всего выражается безразмерной величиной, отношением или логарифмом отношений.

Вопрос выбора модели контраста важен, потому что контраст является определяющим свойством при определении удобочитаемости текста \cite{wcag1}.

В общем случае контрастность можно вычислить по формуле \ref{eq:cr} \cite{weber}:
\begin{equation}
	\label{eq:cr}
	CR=\frac{L_H}{L_L}, \text{~~~~~$1 \le CR \le \infty$},
\end{equation}
где
\begin{itemize}
	\item $L_H$ -- относительная яркость \cite{relativeluminance} самого яркого цвета, представленного на изображении;
	\item $L_L$ -- относительная яркость самого темного цвета, представленного на изображении;
\end{itemize}

Относительная яркость -- величина в диапазоне от 0 до 1, где в случае 0 -- черный, 1 -- белый.

При $CR = 1$ считается, что изображение не имеет контраста (полностью однотонное).

\subsection{Модель Майкельсона}

Модель контраста Майкельсона определяется по формуле \ref{eq:michelson} \cite{weber}:
\begin{equation}
	\label{eq:michelson}
	C_M=\frac{L_H-L_L}{L_H+L_L}, \text{~~~~~$0 \le C_M \le 1$},
\end{equation}

При $C_M = 0$ считается, что изображение не имеет контраста (полностью однотонное).

Данная модель не учитывает влияние окружающего освещения, которое может исказить контраст изображения на дисплее.

\subsection{Модель Вебера}

Модель контраста Вебера определяется по формуле \ref{eq:michelson} \cite{weber}:
\begin{equation}
	\label{eq:weber}
	C_W=\frac{L_H-L_L}{L_H}, \text{~~~~~$0 \le C_W \le 1$},
\end{equation}

При $C_W = 0$ считается, что изображение не имеет контраста (полностью однотонное).

Данная модель также не учитывает влияние окружающего освещения, которое может исказить контраст изображения на дисплее.

\subsection{Модифицированная модель Вебера}

Модифицированная модель контраста Вебера определяется по формуле \ref{eq:webermod} \cite{weber}:
\begin{equation}
	\label{eq:webermod}
	C_mW=\frac{L_H-L_L}{L_H + 0.05},
\end{equation}

В данном случае в знаменателе добавлен коэффициент, позволяющий более точно смоделировать контраст изображения с учетом окружающего освещения.

\section{Выбор модели контраста для решения задачи}

Для решения задачи выбрана модифицированная модель контраста Вебера, так как она:

\begin{itemize}
	\item учитывает влияние окружающего освещения при подсчете контрастности;
	\item используется в качестве основной при подсчете контрастности по стандарту WCAG \cite{wcag}.
\end{itemize}

\section{Анализ возможных решений}

В данном подразделе представлен сравнительный анализ возможных решений поставленной задачи.

\subsection{Наивная инверсия}

Метод наивной инверсии предполагает собой получение инвертированного значения компонента цвета путем вычитания из максимально возможного значения параметра компонента текущего значения. В формуле \ref{eq:invert} показан пример инвертирования цвета для цветовой модели RGB.

Наивная инверсия цвета даст некорректный в контексте работы результат: при инверсии цветов некоторых элементов (например, фон и текст), их конечное отображение может оказаться нечитаемым, потому что не будет удовлетворено соотношение 7:1 или 4.5:1 \cite{wcag1} для самого светлого и самого темного цветов страницы, а также соотношение 3:1 \cite{wcag2} для цветов смежных (имеющих общую границу) элементов. На рисунках \ref{img:example1} и \ref{img:example1_inv} показаны исходное состояние веб-страницы и состояние, на котором инвертированы цвета, соответственно.

Данный результат обусловлен тем, что при инвертировании темного цвета в результате получается светлый цвет. Такое изменение корректно в случае, если меняется цвет текста, но некорректно, если меняется цвет фона. Помимо этого, читаемость текста на измененных веб-страницах может не всегда быть приемлемой. Полученные цвета текста и фона могут не давать соотношение контрастности 4.5:1 или, в лучшем случае, 7:1. Также цвета смежных (имеющих общую границу) элементов могут не иметь соотношение контрастности 3:1. Данные соотношения являются рекомендованными согласно стандарту WCAG 2.1 \cite{wcag}, описывающему требования к отображению элементов веб-страницы. Несоответствие результатов стандарту противоречит поставленной цели.

%\clearpage

\img{100mm}{example1}{Исходное состояние веб-страницы}
\img{100mm}{example1_inv}{Cостояние веб-страницы c инвертированными цветами}

%\clearpage

\subsection{Изменение цвета компонентов на основе анализа цветовой карты}

Метод изменения цвета компонентов на основе анализа цветовой карты  предполагает собой изменение только базовых цветов страницы (наиболее часто встречающихся на странице). Для определения доминантного цвета можно воспользоваться методом $k$-средних \cite{kmeans}, который позволяет произвести кластеризацию участков изображения. Причем под изменением предполагается не инверсия, а выбор близкого по цветовой модели к инвертированному цвета с учетом условий сохранения читаемости \cite{wcag} (cоотношения контрастности самого светлого и самого темного цветов страницы, цветов смежных элементов). После преобразования базовых цветов остальные цвета на странице подбираются в соответствии с преобразованными цветами в том же спектре, что и базовые, но с другими параметрами цветовой модели (например, насыщенность в модели HSL). Такое преобразование позволяет сохранить изначальную визуальную структуру страницы.
 
Выбор цветов стоит производить также опираясь на характеристику контраста \cite{contrast}, чтобы обеспечить приемлемый уровень читаемости текста.

Исходя из понятия контраста и рекомендаций WCAG, для подбора цветов элементов страницы можно воспользоваться формулой  \ref{eq:contrastratio} \cite{wcagcontrast}:
\begin{equation}
	\label{eq:contrastratio}
	\frac{L1 + 0.05}{L2 + 0.05},
\end{equation}
где
\begin{itemize}
	\item L1 -- относительная яркость самого яркого из цветов, представленных на странице.
	\item L2 -- относительная яркость самого темного из цветов, представленных на странице.
\end{itemize}

Под самым ярким и самым темным цветами подразумеваются цвета, имеющие наибольший и наименьший параметр L (Lightness) в цветовой модели HSL, соответственно.

Данная формула является модифицированной формулой Вебера \cite{weber} нахождения контраста. Модификация более точно моделирует потерю контрастности, возникающую при более низкой яркости дисплея из-за условий окружающего освещения. Увеличенную точность обеспечивают дополнительные коэффициенты в числителе и знаменателе.

На рисунках \ref{img:example2} и \ref{img:palette1} представлены исходное состояние веб-страницы и её цветовая карта соответственно.

%\clearpage

\img{100mm}{example2}{Исходное состояние веб-страницы}
\img{100mm}{palette1}{Цветовая карта веб-страницы}

%\clearpage

На основе анализа цветовой карты можно произвести преобразование цветов. Полученный результат показан на рисунке \ref{img:example2_inv}.

\img{100mm}{example2_inv}{Cостояние веб-страницы c преобразованными цветами}

Полученного результата трудно достичь, используя цветовую модель RGB, потому что она не позволяет определить близость расположения цветов в цветовой палитре, что необходимо для обеспечения удобочитаемого распределения цветов при преобразовании цветовой схемы. Чтобы достичь такого результата, можно использовать цветовую модель HSL, которая позволяет определять близость цветов.

Данное решение вписывается в цель работы и будет реализовано в дальнейшем.

\section{Анализ существующих решений}

В качестве существующих решений для анализа выбраны расширение для браузеров Night Eye \cite{nighteye} и встроенная в браузер Google Chrome \cite{chrome} опция Chrome Dark Mode \cite{chromedarkmode}.

В таблице \ref{tbl:solutions} представлен сравнительный анализ существующих решений.

\begin{table}[H]
	\caption{Анализ существующих решений}
	\centering
	\resizebox{\textwidth}{!}{%
		\label{tbl:solutions}
		\begin{tabular}{|l|l|l|l|}
			\hline
			\textbf{\begin{tabular}[c]{@{}l@{}}Название \\ решения\end{tabular}} &
			\textbf{\begin{tabular}[c]{@{}l@{}}Используемая \\ цветовая \\ модель\end{tabular}} &
			\textbf{\begin{tabular}[c]{@{}l@{}}Используемая \\ модель \\ контраста\end{tabular}} &
			\textbf{\begin{tabular}[c]{@{}l@{}}Метод \\ изменения \\ цветов\end{tabular}} \\ 
			\hline
			Night Eye &
			RGB &
			Не указано &
			Наивная инверсия \\ \hline
			Chrome Dark Mode &
			HSL &
			Микельсон &
			Нейронная сеть анализа \\ \hline
		\end{tabular}%
	}
\end{table}

\section*{Вывод}

В данном разделе был проведен анализ цветовых моделей, возможных и существующих решений поставленной задачи. В качестве основной цветовой модели, при помощи которой будет решаться задача, была выбрана модель HSL, а метода изменения цветовой палитры -- метод изменения цвета компонентов на основе анализа цветовой карты.